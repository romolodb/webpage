<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Event TCG - Final Mix</title>
    <style>
        :root {
            --bg-color: #151515;
            --pack-c1: #0f2027;
            --pack-c2: #203a43;
            --pack-c3: #2c5364;
            --gold: #ffd700;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none;
            user-select: none;
        }

        /* --- PARTE SBUSTO (NUOVA - ZIP & GLASS) --- */
        
        /* Scritta Glass Animata */
        .instruction-text {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            text-align: center;
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(90deg, #ff9a9e 0%, #fad0c4 25%, #a18cd1 50%, #fbc2eb 75%, #ff9a9e 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s linear infinite;
            filter: drop-shadow(0 0 8px rgba(255, 192, 203, 0.6));
            z-index: 20;
            pointer-events: none;
        }
        @keyframes shimmer { to { background-position: 200% center; } }

        .scene {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            perspective: 1000px;
        }

        .pack-container {
            position: relative; width: 240px; height: 360px; z-index: 10;
        }

        .pack-top {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: linear-gradient(135deg, #2c5364, #203a43);
            border-top-left-radius: 12px; border-top-right-radius: 12px;
            z-index: 5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.4s ease-in, opacity 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .pack-top span { font-size: 10px; color: rgba(255,255,255,0.2); letter-spacing: 2px; }

        .cut-strip {
            position: absolute;
            top: 50px; left: -2px; width: calc(100% + 4px);
            height: 16px;
            background: #000;
            z-index: 4;
            display: flex; align-items: center; justify-content: center;
            cursor: crosshair;
            box-shadow: inset 0 0 5px rgba(0,0,0,1);
        }
        .cut-strip::after { content: ''; width: 94%; height: 1px; border-bottom: 2px dashed #555; }

        .pack-bottom {
            position: absolute;
            top: 66px; left: 0; width: 100%; height: 294px;
            background: linear-gradient(135deg, #203a43, #0f2027);
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
            z-index: 5;
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .pack-logo {
            font-size: 45px; font-weight: 900; color: white;
            transform: rotate(-5deg); text-shadow: 0 4px 0 rgba(0,0,0,0.5);
            line-height: 1; text-align: center;
            background: -webkit-linear-gradient(#fff, #999);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Animazioni Apertura */
        .pack-container.opened .pack-top { transform: translateY(-120px) rotate(-20deg) scale(0.9); opacity: 0; }
        .pack-container.opened .cut-strip, .pack-container.opened .instruction-text { opacity: 0; transition: opacity 0.2s; }

        /* Canvas Particelle */
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: auto; }


        /* --- PARTE CARTE (COPIATA DAL VECCHIO CODICE) --- */
        
        .cards-stage {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Lascia passare i click se vuoto */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
        }

        .card {
            width: 150px;
            height: 220px;
            background-color: white;
            border-radius: 10px;
            position: absolute;
            /* Inizialmente invisibili e al centro */
            opacity: 0;
            transform: scale(0.5) translateY(100px);
            
            background-size: cover;
            background-position: center;
            border: 4px solid #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            
            pointer-events: auto; /* Riattiva click sulla carta */
            transition: transform 0.2s ease, z-index 0s;
        }

        /* Rarità */
        .card.rare { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); }
        
        .card-name {
            position: absolute; bottom: 0; width: 100%;
            background: rgba(0,0,0,0.7); color: white;
            font-size: 12px; text-align: center; padding: 4px 0;
        }

        /* ANIMAZIONE CHIAVE (Esattamente come da tuo codice) */
        @keyframes dealCard {
            0% {
                opacity: 0;
                transform: translateY(100px) scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: translateY(-50px) scale(1.1) rotate(var(--mid-rot)); /* Salto in alto */
            }
            100% {
                opacity: 1;
                transform: translate(var(--end-x), var(--end-y)) rotate(var(--end-rot)) scale(1);
            }
        }

        /* Classe per attivare l'animazione */
        .card.animate-in {
            animation: dealCard 0.6s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        /* Interazione Carte (Hover del vecchio codice) */
        .card:hover {
            z-index: 100 !important;
            transform: translate(var(--end-x), var(--end-y)) rotate(0deg) scale(1.15) !important;
            transition: transform 0.2s;
            cursor: pointer;
        }


        /* Utils */
        .flash { position: fixed; top:0; left:0; width:100%; height:100%; background: white; opacity: 0; pointer-events: none; z-index: 50; transition: opacity 0.2s; }
        .reset-btn { position: absolute; bottom: 30px; padding: 10px 25px; border-radius: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; display:none; z-index: 100; cursor:pointer; backdrop-filter: blur(5px);}
    </style>
</head>
<body>

    <div class="flash" id="flash"></div>

    <div class="scene">
        <canvas id="particle-canvas"></canvas>

        <div class="pack-container" id="pack">
            <div class="instruction-text">Scorri da sinistra a destra sul tratteggio</div>

            <div class="pack-top"><span>EVENT PACK</span></div>
            <div class="cut-strip" id="cut-strip"></div>
            <div class="pack-bottom">
                <div class="pack-logo">PARTY<br>TIME</div>
            </div>
        </div>

        <div class="cards-stage" id="cards-stage"></div>
    </div>

    <button class="reset-btn" id="reset-btn" onclick="location.reload()">Apri Ancora</button>

    <script>
        // --- DB CARTE ---
        const CARDS_DB = [
            { name: "Ospite 1", type: "common", img: "https://via.placeholder.com/200/3498db/fff" },
            { name: "Ospite 2", type: "common", img: "https://via.placeholder.com/200/9b59b6/fff" },
            { name: "DJ Guest", type: "rare", img: "https://via.placeholder.com/200/f1c40f/000" },
            { name: "Barista", type: "common", img: "https://via.placeholder.com/200/e67e22/fff" },
            { name: "VIP", type: "rare", img: "https://via.placeholder.com/200/e74c3c/fff" }
        ];

        // --- MOTORE PARTICELLE (NUOVO) ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        const strip = document.getElementById('cut-strip');
        const pack = document.getElementById('pack');
        
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();

        let particles = [];
        let isCutting = false;
        let isOpened = false;
        let cutProgress = 0;
        let lastX = 0;

        class Particle {
            constructor(x, y) {
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1.0;
                this.decay = Math.random() * 0.08 + 0.03;
                this.hue = Math.random() < 0.5 ? 45 : 300; 
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vy += 0.1;
                this.life -= this.decay;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = `hsl(${this.hue}, 100%, 60%)`;
                ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.beginPath(); ctx.arc(this.x, this.y, 1, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw(ctx);
                if (particles[i].life <= 0) particles.splice(i, 1);
            }
            requestAnimationFrame(loop);
        }
        loop();

        // --- GESTIONE DRAG/ZIP (NUOVO) ---
        function getPos(e) {
            if(e.touches) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        }

        function handleStart(e) {
            if(isOpened) return;
            isCutting = true;
            lastX = getPos(e).x;
        }

        function handleMove(e) {
            if(!isCutting || isOpened) return;
            const pos = getPos(e);
            const rect = strip.getBoundingClientRect();
            const padding = 20; 

            if (pos.y < rect.top - padding || pos.y > rect.bottom + padding) return;

            for(let i=0; i<4; i++) particles.push(new Particle(pos.x, pos.y));

            if (pos.x > lastX) {
                const relX = pos.x - rect.left;
                const pct = (relX / rect.width) * 100;
                if(pct > cutProgress) cutProgress = pct;
            }
            lastX = pos.x;

            if(cutProgress > 95) openPack();
        }

        function handleEnd() { isCutting = false; }

        ['mousedown','touchstart'].forEach(e => canvas.addEventListener(e, handleStart));
        ['mousemove','touchmove'].forEach(e => canvas.addEventListener(e, handleMove));
        ['mouseup','touchend'].forEach(e => window.addEventListener(e, handleEnd));

        // --- APERTURA (MISTO) ---
        function openPack() {
            if(isOpened) return;
            isOpened = true;
            isCutting = false;
            if(navigator.vibrate) navigator.vibrate(200);

            const rect = strip.getBoundingClientRect();
            for(let i=0; i<40; i++) particles.push(new Particle(rect.left + rect.width/2, rect.top));

            pack.classList.add('opened');

            setTimeout(() => {
                document.getElementById('flash').style.opacity = 1;
                setTimeout(() => {
                    pack.style.display = 'none';
                    document.getElementById('flash').style.opacity = 0;
                    dealCards(); // CHIAMA LA VECCHIA FUNZIONE
                }, 200);
            }, 400);
        }

        // --- DISTRIBUZIONE CARTE (COPIATO ESATTAMENTE DAL VECCHIO CODICE) ---
        function dealCards() {
            const screenW = window.innerWidth;
            const isMobile = screenW < 600;

            const cardsStage = document.getElementById('cards-stage'); // Riferimento

            // CONFIGURAZIONE POSIZIONI
            // Se mobile: carte vicine (overlap 30px). Se desktop: larghe (120px)
            const overlap = isMobile ? 40 : 130; 
            const totalCards = 5;
            // Centro geometrico
            const startX = -((totalCards - 1) * overlap) / 2;

            for (let i = 0; i < totalCards; i++) {
                const cardData = CARDS_DB[Math.floor(Math.random() * CARDS_DB.length)]; // Random placeholder
                
                const card = document.createElement('div');
                card.className = `card ${cardData.type}`;
                card.style.backgroundImage = `url('${cardData.img}')`;
                card.innerHTML = `<div class="card-name">${cardData.name}</div>`;
                
                // --- CALCOLO VARIABILI CSS PER L'ANIMAZIONE ---
                const finalX = startX + (i * overlap);
                // Arco: le carte centrali sono più in alto (valore Y negativo)
                const finalY = Math.abs(i - 2) * (isMobile ? 5 : 15); 
                const finalRot = (i - 2) * 5; // Rotazione finale (-10deg a +10deg)
                
                // Setta variabili CSS sull'elemento
                card.style.setProperty('--end-x', `${finalX}px`);
                card.style.setProperty('--end-y', `${finalY}px`);
                card.style.setProperty('--end-rot', `${finalRot}deg`);
                card.style.setProperty('--mid-rot', `${(Math.random() * 30) - 15}deg`); // Rotazione casuale durante il salto

                // Gestione Z-Index per stack corretto
                card.style.zIndex = i;
                
                // Evento click per portare in primo piano
                card.onclick = function() {
                    document.querySelectorAll('.card').forEach(c => c.style.zIndex = '0');
                    this.style.zIndex = '100';
                }

                cardsStage.appendChild(card);

                // Avvia animazione con leggero ritardo a cascata
                setTimeout(() => {
                    card.classList.add('animate-in');
                }, i * 150);
            }

            // Mostra bottone reset
            setTimeout(() => {
                document.getElementById('reset-btn').style.display = 'block';
            }, 2000);
        }

    </script>
</body>
</html>